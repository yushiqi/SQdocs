## 5.2 Pandas

**Pandas** 是 [Python](https://www.python.org/) 的核心数据分析支持库，提供了快速、灵活、明确的数据结构，旨在简单、直观地处理关系型、标记型数据。Pandas 的目标是成为 Python 数据分析实践与实战的必备高级工具，其长远目标是成为**最强大、最灵活、可以支持任何语言的开源数据分析工具**。



Pandas 适用于处理以下类型的数据：

- 与 SQL 或 Excel 表类似的，含异构列的表格数据;
- 有序和无序（非固定频率）的时间序列数据;
- 带行列标签的矩阵数据，包括同构或异构型数据;
- 任意其它形式的观测、统计数据集, 数据转入 Pandas 数据结构时不必事先标记。



### 1. 安装

使用Anaconda安装

```shell
conda install pandas
```

使用PyPI安装

```shell
pip install pandas
```



### 2.数据结构简介

#### 2.1 Series

Series 是带标签的一维数组，可存储整数、浮点数、字符串、Python 对象等类型的数据。轴标签统称为**索引**。调用 `pd.Series` 函数即可创建 Series：

```python
s = pd.Series(data, index=index)
```

`data`支持一下数据类型

- Python字典
- 多维数组
- 标量值

`index`是轴标签列表，也就是索引



**使用Python字典创建Series**

```python
d = {'a':1, 'b':2, 'c':3}
pd.Series(d)

a    1
b    2
c    3
dtype: int64
```

**使用多维数组创建Series**

```python
pd.Series(np.random.randn(5), index=['a', 'b', 'c', 'd', 'e'])

a   -1.933183
b    0.300629
c    0.386382
d    0.707157
e   -0.515151
dtype: float64
```

**使用标量值创建Series**

```python
pd.Series(5., index=['a', 'b', 'c', 'd', 'e'])

a    5.0
b    5.0
c    5.0
d    5.0
e    5.0
dtype: float64
```



#### 2.2 DataFrame

DataFrame是由多种类型的列构成的二维标签数据结构，类似于 Excel 、SQL 表，或 Series 对象构成的字典。DataFrame 是最常用的 Pandas 对象，与 Series 一样，DataFrame 支持多种类型的输入数据：

- 一维 ndarray、列表、字典、Series 字典
- 二维 numpy.ndarray
- 结构多维数组或记录多维数组
- `Series`
- `DataFrame`

除了数据，还可以有选择地传递 **index**（行标签）和 **columns**（列标签）参数。传递了索引或列，就可以确保生成的 DataFrame 里包含索引或列。Series 字典加上指定索引时，会丢弃与传递的索引不匹配的所有数据。



**用 Series 字典或字典生成 DataFrame**

```python
d = {'one': pd.Series([1., 2., 3.], index=['a', 'b', 'c']),'two': pd.Series([1., 2., 3., 4.], index=['a', 'b', 'c', 'd'])}

pd.DataFrame(d)

pd.DataFrame(d, index=['d', 'b', 'a'])


```

执行结果

```txt
	one	two
a	1.0	1.0
b	2.0	2.0
c	3.0	3.0
d	NaN	4.0

	one	two
d	NaN	4.0
b	2.0	2.0
a	1.0	1.0

	two	three
d	4.0	NaN
b	2.0	NaN
a	1.0	NaN
```

> **注意：指定的列与字典一起传递时，传递的列会覆盖字典的键。**



**用多维数组字典、列表字典生成 DataFrame**

```python
d = {'one': [1., 2., 3., 4.], 'two': [4., 3., 2., 1.]}
pd.DataFrame(d, index=['a', 'b', 'c', 'd'])
```

执行结果

```txt
	one	two
a	1.0	4.0
b	2.0	3.0
c	3.0	2.0
d	4.0	1.0
```



**用结构多维数组或记录多维数组生成 DataFrame**

```python
data = np.zeros((2, ), dtype=[('A', 'i4'), ('B', 'f4'), ('C', 'a10')])

data[:] = [(1, 2., 'Hello'), (2, 3., "World")]

pd.DataFrame(data, index=['first', 'second'], columns=['C', 'A', 'B'])
```

执行结果

```txt
		C			A	B
first	b'Hello'	1	2.0
second	b'World'	2	3.0
```



**用列表字典生成 DataFrame**

```python
data = [{'a': 1, 'b': 2}, {'a': 5, 'b': 10, 'c': 20}]

pd.DataFrame(data, index=['first', 'second'])
```

执行结果

```txt
		a	b	c
first	1	2	NaN
second	5	10	20.0
```



**用元组字典生成 DataFrame**

```python
pd.DataFrame({('a', 'b'): {('A', 'B'): 1, ('A', 'C'): 2},
                ('a', 'a'): {('A', 'C'): 3, ('A', 'B'): 4},
                ('a', 'c'): {('A', 'B'): 5, ('A', 'C'): 6},
                ('b', 'a'): {('A', 'C'): 7, ('A', 'B'): 8},
                ('b', 'b'): {('A', 'D'): 9, ('A', 'B'): 10}})
```

执行结果

```txt
		a			b
		b	a	c	a	b
A	B	1.0	4.0	5.0	8.0	10.0
	C	2.0	3.0	6.0	7.0	NaN
	D	NaN	NaN	NaN	NaN	9.0
```



### 3. 基础入门

#### 3.1 查看数据

查看头部和尾部数据

```python
data_index = pd.date_range(start='1/1/2020', periods=100)

df = pd.DataFrame(np.random.randn(500).reshape(100,5), index=data_index, columns=['A','B','C','D','E'])

df.head()

			A			B			C			D			E
2020-01-01	-1.071938	-0.388269	0.404821	-0.674684	1.082843
2020-01-02	-0.347211	1.977614	-0.050738	-0.046957	0.246992
2020-01-03	0.129989	-0.445965	-0.235185	-0.265440	-1.086967
2020-01-04	0.616785	0.262000	-1.290709	1.218618	0.720770
2020-01-05	-2.115399	1.179655	-0.290259	0.781388	1.021759

df.tail(3)

			A			B			C			D			E
2020-04-07	1.107176	-1.507005	0.442401	0.767987	0.772502
2020-04-08	-1.543107	0.356048	-0.246524	1.469017	-0.282765
2020-04-09	-0.242034	0.494868	1.958897	-0.281020	-1.177761
```



显示索引与列名

```python
df.index

DatetimeIndex(['2020-01-01', '2020-01-02', '2020-01-03', '2020-01-04',
               '2020-01-05', '2020-01-06', '2020-01-07', '2020-01-08',
               '2020-01-09', '2020-01-10', '2020-01-11', '2020-01-12',
               '2020-01-13', '2020-01-14', '2020-01-15', '2020-01-16',
               '2020-01-17', '2020-01-18', '2020-01-19', '2020-01-20',
               '2020-01-21', '2020-01-22', '2020-01-23', '2020-01-24',
               '2020-01-25', '2020-01-26', '2020-01-27', '2020-01-28',
               '2020-01-29', '2020-01-30', '2020-01-31', '2020-02-01',
               '2020-02-02', '2020-02-03', '2020-02-04', '2020-02-05',
               '2020-02-06', '2020-02-07', '2020-02-08', '2020-02-09',
               '2020-02-10', '2020-02-11', '2020-02-12', '2020-02-13',
               '2020-02-14', '2020-02-15', '2020-02-16', '2020-02-17',
               '2020-02-18', '2020-02-19', '2020-02-20', '2020-02-21',
               '2020-02-22', '2020-02-23', '2020-02-24', '2020-02-25',
               '2020-02-26', '2020-02-27', '2020-02-28', '2020-02-29',
               '2020-03-01', '2020-03-02', '2020-03-03', '2020-03-04',
               '2020-03-05', '2020-03-06', '2020-03-07', '2020-03-08',
               '2020-03-09', '2020-03-10', '2020-03-11', '2020-03-12',
               '2020-03-13', '2020-03-14', '2020-03-15', '2020-03-16',
               '2020-03-17', '2020-03-18', '2020-03-19', '2020-03-20',
               '2020-03-21', '2020-03-22', '2020-03-23', '2020-03-24',
               '2020-03-25', '2020-03-26', '2020-03-27', '2020-03-28',
               '2020-03-29', '2020-03-30', '2020-03-31', '2020-04-01',
               '2020-04-02', '2020-04-03', '2020-04-04', '2020-04-05',
               '2020-04-06', '2020-04-07', '2020-04-08', '2020-04-09'],
              dtype='datetime64[ns]', freq='D')
              
df.columns

Index(['A', 'B', 'C', 'D', 'E'], dtype='object')
```



`describe()`快速查看数据摘要

```python
df.describe()

		A			B			C			D			E
count	100.000000	100.000000	100.000000	100.000000	100.000000
mean	-0.189421	0.092631	-0.002600	-0.027843	0.156094
std		0.988333	1.087173	0.930738	0.933235	1.026329
min		-2.524124	-2.034074	-2.002786	-1.935007	-1.983693
25%		-0.840493	-0.735936	-0.673191	-0.712899	-0.433909
50%		-0.180693	0.009894	0.032741	-0.076358	0.096075
75%		0.492854	0.781675	0.587729	0.595442	0.728967
max		2.080747	3.577149	2.466595	2.611626	3.322429
```



转置数据

```python
df.head(3).T

	2020-01-01 00:00:00	2020-01-02 00:00:00	2020-01-03 00:00:00
A	-1.071938			-0.347211			0.129989
B	-0.388269			1.977614			-0.445965
C	0.404821			-0.050738			-0.235185
D	-0.674684			-0.046957			-0.265440
E	1.082843			0.246992			-1.086967
```



按轴排序

```python
df.sort_index(axis=1, ascending=False).head(3)

			E			D			C			B			A
2020-01-01	1.082843	-0.674684	0.404821	-0.388269	-1.071938
2020-01-02	0.246992	-0.046957	-0.050738	1.977614	-0.347211
2020-01-03	-1.086967	-0.265440	-0.235185	-0.445965	0.129989
```



按值排序

```python
df.sort_values(by='C', ascending=False).head(3)

			A			B			C			D			E
2020-01-14	0.340972	-0.726843	2.466595	0.766566	0.825533
2020-04-09	-0.242034	0.494868	1.958897	-0.281020	-1.177761
2020-04-06	0.847497	0.408494	1.748987	-1.200556	-0.192185
```



#### 3.2 选择

> 提醒: 选择、设置标准 Python / Numpy 的表达式已经非常直观，交互也很方便，但对于生产代码，还是推荐优化过的 Pandas 数据访问方法：`.at`、`.iat`、`.loc` 和 `.iloc`。



测试数据

```python
data_index = pd.date_range(start='1/1/2020', periods=8)

df = pd.DataFrame(np.random.randn(32).reshape(8,4), index=data_index, columns=['A','B','C','D'])

			A			B			C			D
2020-01-01	-0.534738	1.198495	1.099884	0.646788
2020-01-02	0.661826	0.633155	-0.467720	-1.329015
2020-01-03	-0.084597	0.575203	-0.080986	-0.476005
2020-01-04	-1.013491	0.168052	0.445559	0.308987
2020-01-05	1.193184	1.078068	-0.968468	-0.024408
2020-01-06	-1.451905	-1.124250	0.366782	-0.711344
2020-01-07	0.951567	-0.333190	1.404569	0.574293
2020-01-08	1.007324	-1.543192	-0.451113	-0.944006
```



**获取数据**

选择单列，生成Series，等效于`df.A`

```python
df['A']

2020-01-01   -0.534738
2020-01-02    0.661826
2020-01-03   -0.084597
2020-01-04   -1.013491
2020-01-05    1.193184
2020-01-06   -1.451905
2020-01-07    0.951567
2020-01-08    1.007324
Freq: D, Name: A, dtype: float64
```

切片`[]`选择行

```python
df[1:3]

			A			B			C			D
2020-01-02	0.661826	0.633155	-0.467720	-1.329015
2020-01-03	-0.084597	0.575203	-0.080986	-0.476005


df['2020-01-03':'2020-01-05']

			A			B			C			D
2020-01-03	-0.084597	0.575203	-0.080986	-0.476005
2020-01-04	-1.013491	0.168052	0.445559	0.308987
2020-01-05	1.193184	1.078068	-0.968468	-0.024408
```



**按标签选择**

用标签提取一行数据

```python
df.loc['2020-01-03']

A   -0.084597
B    0.575203
C   -0.080986
D   -0.476005
Name: 2020-01-03 00:00:00, dtype: float64
```

用标签选择多列数据

```python
df.loc[:,['A','D']]

			A			D
2020-01-01	-0.534738	0.646788
2020-01-02	0.661826	-1.329015
2020-01-03	-0.084597	-0.476005
2020-01-04	-1.013491	0.308987
2020-01-05	1.193184	-0.024408
2020-01-06	-1.451905	-0.711344
2020-01-07	0.951567	0.574293
2020-01-08	1.007324	-0.944006
```

用标签切片，包含行与列的结束点

```python
df.loc['2020-01-03':'2020-01-06', 'B':'D']

			B			C			D
2020-01-03	0.575203	-0.080986	-0.476005
2020-01-04	0.168052	0.445559	0.308987
2020-01-05	1.078068	-0.968468	-0.024408
2020-01-06	-1.124250	0.366782	-0.711344
```

提取标量值

```python
df.loc['2020-01-03', 'B']

0.5752031238478458
```

快速访问标量值也可以使用`df.at`

```python
df.loc['2020-01-03'].at['B']

0.5752031238478458
```



**按照位置选择**

用整数位置选择

```python
df.iloc[3]

A   -1.013491
B    0.168052
C    0.445559
D    0.308987
Name: 2020-01-04 00:00:00, dtype: float64
```

用整数切片

```python
df.iloc[3:5, 1:3]

			B			C
2020-01-04	0.168052	0.445559
2020-01-05	1.078068	-0.968468
```

用整数列表按照位置切片

```python
df.iloc[[1,4,2], [3,1]]

			D			B
2020-01-02	-1.329015	0.633155
2020-01-05	-0.024408	1.078068
2020-01-03	-0.476005	0.575203
```

显示整行切片

```python
df.iloc[1:3, :]

			A			B			C			D
2020-01-02	0.661826	0.633155	-0.467720	-1.329015
2020-01-03	-0.084597	0.575203	-0.080986	-0.476005
```

显示整列切片

```python
df.iloc[:, 1:3]

			B			C
2020-01-01	1.198495	1.099884
2020-01-02	0.633155	-0.467720
2020-01-03	0.575203	-0.080986
2020-01-04	0.168052	0.445559
2020-01-05	1.078068	-0.968468
2020-01-06	-1.124250	0.366782
2020-01-07	-0.333190	1.404569
2020-01-08	-1.543192	-0.451113
```

显示标量值

```python
df.iloc[2,2]

-0.08098568559057222
```

快速访问标量值也可以使用`df.iat`

```python
df.iat[2,2]

-0.08098568559057222
```



**布尔索引**

用单列的值选择数据

```python
df[df.A>0]

			A			B			C			D
2020-01-02	0.661826	0.633155	-0.467720	-1.329015
2020-01-05	1.193184	1.078068	-0.968468	-0.024408
2020-01-07	0.951567	-0.333190	1.404569	0.574293
2020-01-08	1.007324	-1.543192	-0.451113	-0.944006
```

选择整个DataFrame里满足条件的值

```python
df[df>1]

			A			B			C			D
2020-01-01	NaN			1.198495	1.099884	NaN
2020-01-02	NaN			NaN			NaN			NaN
2020-01-03	NaN			NaN			NaN			NaN
2020-01-04	NaN			NaN			NaN			NaN
2020-01-05	1.193184	1.078068	NaN			NaN
2020-01-06	NaN			NaN			NaN			NaN
2020-01-07	NaN			NaN			1.404569	NaN
2020-01-08	1.007324	NaN			NaN			NaN
```

用`isin()`筛选

```python
df2 = df.copy()

df2['E'] = ['A', 'C', 'B', 'C', 'D', 'A', 'C', 'C']

df2

			A			B			C			D			E
2020-01-01	-0.534738	1.198495	1.099884	0.646788	A
2020-01-02	0.661826	0.633155	-0.467720	-1.329015	C
2020-01-03	-0.084597	0.575203	-0.080986	-0.476005	B
2020-01-04	-1.013491	0.168052	0.445559	0.308987	C
2020-01-05	1.193184	1.078068	-0.968468	-0.024408	D
2020-01-06	-1.451905	-1.124250	0.366782	-0.711344	A
2020-01-07	0.951567	-0.333190	1.404569	0.574293	C
2020-01-08	1.007324	-1.543192	-0.451113	-0.944006	C

df2[df2['E'].isin(['B', 'C', 'F'])]

			A			B			C			D			E
2020-01-02	0.661826	0.633155	-0.467720	-1.329015	C
2020-01-03	-0.084597	0.575203	-0.080986	-0.476005	B
2020-01-04	-1.013491	0.168052	0.445559	0.308987	C
2020-01-07	0.951567	-0.333190	1.404569	0.574293	C
2020-01-08	1.007324	-1.543192	-0.451113	-0.944006	C
```



**赋值**

用索引自动对齐，新增列数据

```python
s = pd.Series([1,2,3,4,5,6,7,8], index=pd.date_range(start='1/1/2020',periods=8))

df['E'] = s

df

			A			B			C			D			E
2020-01-01	-0.534738	1.198495	1.099884	0.646788	1
2020-01-02	0.661826	0.633155	-0.467720	-1.329015	2
2020-01-03	-0.084597	0.575203	-0.080986	-0.476005	3
2020-01-04	-1.013491	0.168052	0.445559	0.308987	4
2020-01-05	1.193184	1.078068	-0.968468	-0.024408	5
2020-01-06	-1.451905	-1.124250	0.366782	-0.711344	6
2020-01-07	0.951567	-0.333190	1.404569	0.574293	7
2020-01-08	1.007324	-1.543192	-0.451113	-0.944006	8
```

按标签赋值

```python
df.loc['2020-01-01','B'] = 0

df

			A			B			C			D			E
2020-01-01	-0.534738	0.000000	1.099884	0.646788	1
2020-01-02	0.661826	0.633155	-0.467720	-1.329015	2
2020-01-03	-0.084597	0.575203	-0.080986	-0.476005	3
2020-01-04	-1.013491	0.168052	0.445559	0.308987	4
2020-01-05	1.193184	1.078068	-0.968468	-0.024408	5
2020-01-06	-1.451905	-1.124250	0.366782	-0.711344	6
2020-01-07	0.951567	-0.333190	1.404569	0.574293	7
2020-01-08	1.007324	-1.543192	-0.451113	-0.944006	8
```

按位置赋值

```python
df.iloc[2,2] = 0

df

			A			B			C			D			E
2020-01-01	-0.534738	0.000000	1.099884	0.646788	1
2020-01-02	0.661826	0.633155	-0.467720	-1.329015	2
2020-01-03	-0.084597	0.575203	0.000000	-0.476005	3
2020-01-04	-1.013491	0.168052	0.445559	0.308987	4
2020-01-05	1.193184	1.078068	-0.968468	-0.024408	5
2020-01-06	-1.451905	-1.124250	0.366782	-0.711344	6
2020-01-07	0.951567	-0.333190	1.404569	0.574293	7
2020-01-08	1.007324	-1.543192	-0.451113	-0.944006	8
```

用Numpy数组赋值

```python
df['E'] = np.array([0] * len(df))

df

			A			B			C			D			E
2020-01-01	-0.534738	0.000000	1.099884	0.646788	0
2020-01-02	0.661826	0.633155	-0.467720	-1.329015	0
2020-01-03	-0.084597	0.575203	0.000000	-0.476005	0
2020-01-04	-1.013491	0.168052	0.445559	0.308987	0
2020-01-05	1.193184	1.078068	-0.968468	-0.024408	0
2020-01-06	-1.451905	-1.124250	0.366782	-0.711344	0
2020-01-07	0.951567	-0.333190	1.404569	0.574293	0
2020-01-08	1.007324	-1.543192	-0.451113	-0.944006	0
```

用`where`条件赋值

```python
df[df>0] = -df

df

			A			B			C			D			E
2020-01-01	-0.534738	0.000000	-1.099884	-0.646788	0
2020-01-02	-0.661826	-0.633155	-0.467720	-1.329015	0
2020-01-03	-0.084597	-0.575203	0.000000	-0.476005	0
2020-01-04	-1.013491	-0.168052	-0.445559	-0.308987	0
2020-01-05	-1.193184	-1.078068	-0.968468	-0.024408	0
2020-01-06	-1.451905	-1.124250	-0.366782	-0.711344	0
2020-01-07	-0.951567	-0.333190	-1.404569	-0.574293	0
2020-01-08	-1.007324	-1.543192	-0.451113	-0.944006	0
```



#### 3.3 缺失值

Pandas使用`np.nan`表示缺失值。计算时，默认不处理缺失值。



测试数据

```python
data_index = pd.date_range(start='1/1/2020', periods=6)

df = pd.DataFrame(np.random.randn(24).reshape(6,4), index=data_index, columns=['A','B','C','D'])

df.iloc[1:4, [2,3]] = np.nan

df.loc['2020-01-06', ['A','C']] = np.nan

df

			A			B			C			D
2020-01-01	-0.522267	1.878701	-0.749467	0.087433
2020-01-02	0.689572	-0.175677	NaN			NaN
2020-01-03	-0.622268	-0.172894	NaN			NaN
2020-01-04	-0.273200	-0.763474	NaN			NaN
2020-01-05	-1.370132	-0.222186	1.114736	-2.165299
2020-01-06	NaN			-0.881161	NaN			1.708045
```

删除所有包含缺失值的列

```python
df.dropna(axis=1, how='any')

			B
2020-01-01	1.878701
2020-01-02	-0.175677
2020-01-03	-0.172894
2020-01-04	-0.763474
2020-01-05	-0.222186
2020-01-06	-0.881161
```

填充缺失值

```python
df.fillna(value=df.max())

			A			B			C			D
2020-01-01	-0.522267	1.878701	-0.749467	0.087433
2020-01-02	0.689572	-0.175677	1.114736	1.708045
2020-01-03	-0.622268	-0.172894	1.114736	1.708045
2020-01-04	-0.273200	-0.763474	1.114736	1.708045
2020-01-05	-1.370132	-0.222186	1.114736	-2.165299
2020-01-06	0.689572	-0.881161	1.114736	1.708045
```

提取缺失值

```python
df.isna()

			A			B	C		D
2020-01-01	False	False	False	False
2020-01-02	False	False	True	True
2020-01-03	False	False	True	True
2020-01-04	False	False	True	True
2020-01-05	False	False	False	False
2020-01-06	True	False	True	False
```



#### 3.4 运算

**统计**

描述性统计

```python
df.mean(axis=0)

2020-01-01    0.173600
2020-01-02    0.256948
2020-01-03   -0.397581
2020-01-04   -0.518337
2020-01-05   -0.660720
2020-01-06    0.413442
Freq: D, dtype: float64
```

不同维度对象运算时，要先对齐。 此外，Pandas 自动沿指定维度广播。`shift`的作用是将数据移动到指定的位置

```python
data_index = pd.date_range(start='1/1/2020', periods=6)

df = pd.DataFrame(np.random.randn(24).reshape(6,4), index=data_index, columns=['A','B','C','D'])

df

			A			B			C			D
2020-01-01	2.247186	-0.547146	-0.581378	-0.757834
2020-01-02	2.158050	-0.526511	1.135555	0.388816
2020-01-03	0.132194	1.810191	0.612350	-0.616597
2020-01-04	1.323747	-0.981873	-0.311311	-1.956533
2020-01-05	0.720286	-0.686399	0.092560	-0.652112
2020-01-06	1.537573	0.916894	-1.132592	-0.280569


s = pd.Series([1, 3, 5, np.nan, 6, 8], index=df.index).shift(2)

s

2020-01-01    NaN
2020-01-02    NaN
2020-01-03    1.0
2020-01-04    3.0
2020-01-05    5.0
2020-01-06    NaN
Freq: D, dtype: float64

df.sub(s, axis=0)

	A	B	C	D
2020-01-01	NaN	NaN	NaN	NaN
2020-01-02	NaN	NaN	NaN	NaN
2020-01-03	-0.867806	0.810191	-0.387650	-1.616597
2020-01-04	-1.676253	-3.981873	-3.311311	-4.956533
2020-01-05	-4.279714	-5.686399	-4.907440	-5.652112
2020-01-06	NaN	NaN	NaN	NaN
```



**常见描述和汇总统计方法**

| 方法           | 说明                                  |
| -------------- | ------------------------------------- |
| count          | 非NA值得数量                          |
| describe       | 针对Series或各DataFrame列计算汇总统计 |
| min、max       | 计算最大值和最小值                    |
| argmin、argmax | 获取最大值和最小值的索引位置          |
| idxmin、idxmax | 获取最大值和最小值的索引值            |
|                |                                       |
|                |                                       |

